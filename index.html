<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title> 체험 페이지 (v7 • ረዳት 포함)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans Ethiopic', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif; }
    #app { min-height: 100dvh; }
    .keycap { white-space: nowrap; }
  </style>
</head>
<body class="bg-[#FAFAFA] text-neutral-900">
  <div id="app"></div>

  <script type="text/babel">
    const { useMemo, useRef, useState, useEffect } = React;

    function RatanamaPlayground() {
      const [posts, setPosts] = useState([
        "ሰላም! ይህ ቦታ ሙከራ ነው. ይህ መተግበሪያ እንዴት ይመስላችኋል?",
        "በእርግጥ ቀላል እና ፈጣን ነው:: ጥሩነው::",
        "በመንካት አንዱን ቁልፍ ይምረጡ እና ቀላል ለመ ስራ ነው። ይቀጥሉ ይርሱ:: እመኛለሁ እባኮትን ልብ ይበሉ::",
      ]);
      const [inputText, setInputText] = useState("");
      const [helpOpen, setHelpOpen] = useState(false);
      const listRef = useRef(null);
      const inputRef = useRef(null);

      const layout = useMemo(() => ({
        Q: ["ገ"], W: ["ወ"], E: ["የ"], R: ["አ","ጸ","ጰ"], T: ["ቀ","ዐ","ፀ"], Y: ["ዘ","ዠ"],
        A: ["ተ","ፐ"], S: ["ረ","ፈ"], D: ["ነ","ኘ","ኀ"], F: ["መ","ሐ"], G: ["ከ","ኸ"], H: ["ጠ","ጨ"],
        Z: ["ደ","ጀ"], X: ["ሰ","ሸ"], C: ["ለ"], V: ["በ","ቨ"], B: ["ሀ","ሠ"], N: ["ቸ"],
        U: ["ኡ"], I: ["ኢ"], O: ["ኦ"], J: ["ኤ"], K: ["ኣ"], L: ["ዉ"], P: ["እ"], M: ["next"],
      }), []);

      const THIN_SPACE = "\u2009";
      const vowelOrderByKey = { U:1, I:2, K:3, J:4, P:5, O:6 };

      
      // robust vowel applier (explicit map -> index)
      const VOWEL_INDEX = { U:1, I:2, K:3, J:4, P:5, O:6 }; // 0=ä,1=u,2=i,3=a,4=e,5=ə,6=o
      const applyVowelByKey = (k) => {
        const orderIndex = VOWEL_INDEX[k];
        if (orderIndex === undefined) return;
        setInputText(prev => {
          if (!prev) return prev;
          const chars = Array.from(prev);
          const last = chars[chars.length - 1];
          const cp = last.codePointAt(0);
          if (cp < 0x1200 || cp > 0x137F) return prev;
          const base = getSeriesBase(cp);
          const newCp = base + orderIndex;
          try { chars[chars.length - 1] = String.fromCodePoint(newCp); return chars.join(""); } catch { return prev; }
        });
        focusAtEnd();
      };

      const wSeriesBaseMap = new Map(Object.entries({
        "ቀ":"ቈ", "ከ":"ኰ", "ገ":"ጐ", "ኸ":"ዀ"
      }));

      const charToGroup = useMemo(() => {
        const map = new Map();
        Object.values(layout).forEach(arr => {
          if (arr[0] === "next") return;
          arr.forEach(ch => map.set(ch, arr));
        });
        return map;
      }, [layout]);

      const focusAtEnd = () => {
        requestAnimationFrame(() => {
          const el = inputRef.current;
          if (!el) return;
          el.focus();
          const len = el.value.length;
          try { el.setSelectionRange(len, len); } catch {}
        });
      };

      const insertChar = (ch) => { setInputText(prev => prev + ch); focusAtEnd(); };
      const backspace = () => { setInputText(prev => prev.slice(0, -1)); focusAtEnd(); };
      const enter = () => { setInputText(prev => prev + "\n"); focusAtEnd(); };
      const space = () => { setInputText(prev => prev + " "); focusAtEnd(); };

      const getSeriesBase = (code) => code - (code % 8);

      const applyVowel = (orderIndex) => {
        setInputText(prev => {
          if (!prev) return prev;
          const chars = Array.from(prev);
          const last = chars[chars.length - 1];
          const cp = last.codePointAt(0);
          if (cp < 0x1200 || cp > 0x137F) return prev;
          const base = getSeriesBase(cp);
          const newCp = base + orderIndex;
          try { chars[chars.length - 1] = String.fromCodePoint(newCp); return chars.join(""); } catch { return prev; }
        });
        focusAtEnd();
      };

      const nextTransform = () => {
        setInputText(prev => {
          if (!prev) return prev;
          const last = Array.from(prev).slice(-1)[0];
          const group = charToGroup.get(last);
          if (!group || group.length < 2) return prev;
          const idx = group.indexOf(last);
          const next = group[(idx + 1) % group.length];
          return prev.slice(0, prev.length - last.length) + next;
        });
        focusAtEnd();
      };

      const applyWCombine = () => {
        setInputText(prev => {
          if (!prev) return prev;
          const chars = Array.from(prev);
          const last = chars[chars.length - 1];
          const cp = last.codePointAt(0);
          if (cp < 0x1200 || cp > 0x137F) return prev;
          const base = getSeriesBase(cp);
          const order = cp - base;
          const baseChar = String.fromCodePoint(base);
          const wBaseChar = wSeriesBaseMap.get(baseChar);
          let newCp = wBaseChar ? wBaseChar.codePointAt(0) + 0 : base + 7;
          try { chars[chars.length - 1] = String.fromCodePoint(newCp); return chars.join(""); } catch { return prev; }
        });
        focusAtEnd();
      };

      const onKeyPress = (k) => {
        if (k === "M") return nextTransform();
        if (k === "L") return applyWCombine();
        if (VOWEL_INDEX[k] !== undefined) return applyVowelByKey(k);
        const arr = layout[k];
        if (!arr || arr[0] === "next") return;
        insertChar(arr[0]);
      };

      // tutorial hotkey
      useEffect(() => {
        const onKey = (e) => {
          if (e.key === '?' || (e.shiftKey && e.key === '/')) setHelpOpen(true);
          if (e.key === 'Escape') setHelpOpen(false);
        };
        window.addEventListener('keydown', onKey);
        return () => window.removeEventListener('keydown', onKey);
      }, []);

      // Components
      const Key = ({ labelArr, onClick, disabled, className, tone, hint }) => {
        const display = labelArr[0] === "next" ? "≫" : labelArr.join(THIN_SPACE);
        const base = 'keycap w-full select-none text-[clamp(14px,2.4vw,22px)] leading-tight flex items-center justify-center h-[56px] md:h-[60px] rounded-none border active:translate-y-[1px]';
        let scheme = 'bg-white border-neutral-200 hover:bg-neutral-50';
        if (tone === 'vowel') scheme = 'bg-sky-100 border-sky-200 hover:bg-sky-50';
        if (tone === 'convert') scheme = 'bg-orange-100 border-orange-200 hover:bg-orange-50';
        if (tone === 'dark') scheme = 'bg-neutral-300 border-neutral-400 text-neutral-900 hover:bg-neutral-200';
        if (disabled && tone !== 'dark') scheme = 'bg-neutral-200 text-neutral-400 border-neutral-200';
        return (
          <button onClick={disabled ? undefined : onClick} disabled={disabled}
            className={`${base} ${scheme} ${className||''}`} title={(hint?hint+" : ":"")+labelArr.join(' ')}>
            <span className={(labelArr[0] === "next") ? "text-[clamp(16px,2.8vw,26px)] font-semibold" : ""}>{display}</span>
            {hint && <span className="absolute left-1 top-1 text-[11px] text-neutral-500 select-none">{hint}</span>}
          </button>
        );
      };

      const WideKey = ({ children, onClick, disabled, className, tone }) => {
        let scheme = 'bg-white hover:bg-neutral-50 border-neutral-200';
        if (tone === 'dark') scheme = 'bg-neutral-300 border-neutral-400 text-neutral-900 hover:bg-neutral-200';
        if (disabled && tone !== 'dark') scheme = 'bg-neutral-200 text-neutral-400 border-neutral-200';
        return (
          <button onClick={disabled ? undefined : onClick} disabled={disabled}
            className={`w-full h-[56px] md:h-[60px] border rounded-none text-[16px] md:text-[18px] ${scheme} ${className||''}`}>
            {children}
          </button>
        );
      };

      
      // series order HUD
      const showHUD = () => {
        const el = inputRef.current;
        if (!el) return;
        const prev = el.value;
        const last = Array.from(prev).slice(-1)[0];
        if (!last) return;
        const cp = last.codePointAt(0);
        const base = getSeriesBase(cp);
        const ord = (cp>=0x1200 && cp<=0x137F) ? (cp - base) : -1;
        const tag = document.getElementById('ordHUD') || (()=>{const d=document.createElement('div'); d.id='ordHUD'; d.className='fixed bottom-2 right-2 text-xs bg-black/70 text-white px-2 py-1 rounded'; document.body.appendChild(d); return d;})();
        tag.textContent = 'order=' + ord;
      };
      useEffect(()=>{ showHUD(); });

      const Row21 = ({ children }) => (
        <div className="grid gap-0 w-full" style={{ gridTemplateColumns: 'repeat(21, minmax(0, 1fr))' }}>{children}</div>
      );

      const Section = ({title, children}) => (
        <section className="mb-6">
          <h3 className="text-lg font-semibold mb-2">{title}</h3>
          <div className="text-[15px] leading-7">{children}</div>
        </section>
      );

      const Badge = ({children, tone}) => {
        const base = "inline-block px-2 py-0.5 rounded border align-middle text-[13px] mr-1";
        let scheme = "bg-white border-neutral-300";
        if (tone==='vowel') scheme="bg-sky-100 border-sky-300";
        if (tone==='convert') scheme="bg-orange-100 border-orange-300";
        if (tone==='dark') scheme="bg-neutral-300 border-neutral-400";
        return <span className={`${base} ${scheme}`}>{children}</span>;
      }

      const savePost = () => {
        const trimmed = inputText.trim();
        if (!trimmed) return;
        setPosts(prev => [trimmed, ...prev]);
        setInputText("");
        requestAnimationFrame(() => listRef.current?.scrollTo({ top: 0, behavior: 'smooth' }));
        focusAtEnd();
      };
      const clearInput = () => { setInputText(""); focusAtEnd(); };
      useEffect(() => { focusAtEnd(); }, []);

      return (
        <div className="min-h-screen w-full flex flex-col">
          {/* header */}
          <div className="flex items-center justify-between px-4 py-3">
            <h1 className="text-xl md:text-2xl font-semibold">ላታናማ የቁልፍ ሙከራ ገጽ</h1>
            <div className="flex items-center gap-3">
              
              <button onClick={()=>setHelpOpen(true)} className="h-9 px-3 rounded-lg bg-neutral-900 text-white text-sm hover:bg-neutral-800">ረዳት</button>
            </div>
          </div>

          {/* posts */}
          <div ref={listRef} className="mx-4 mb-2 rounded-xl bg-white border border-neutral-200 p-3 h-[260px] md:h-[320px] overflow-y-auto">
            {posts.map((p,i) => (
              <div key={i} className="mb-3">
                <div className="whitespace-pre-wrap text-[15px] md:text-[16px] leading-6">{p}</div>
                <div className="h-px bg-neutral-100 mt-2" />
              </div>
            ))}
            {posts.length===0 && (<div className="text-neutral-400">아직 게시된 글이 없습니다. 첫 글을 남겨보세요.</div>)}
          </div>

          {/* input */}
          <div className="mx-4 mb-2">
            <textarea ref={inputRef} value={inputText} onChange={e=>setInputText(e.target.value)} placeholder="እዚህ ጻፉ…" className="w-full h-[88px] md:h-[96px] resize-none rounded-xl border border-neutral-300 bg-white p-3 text-[16px] md:text-[18px] leading-6 focus:outline-none focus:ring-2 focus:ring-amber-300" />
          </div>

          {/* keyboard */}
          <div className="mt-auto">
            {/* Row 1 */}
            <Row21>
              <div className="col-span-2"><Key labelArr={layout.Q} onClick={()=>onKeyPress('Q')} /></div>
              <div className="col-span-2"><Key labelArr={layout.W} onClick={()=>onKeyPress('W')} /></div>
              <div className="col-span-2"><Key labelArr={layout.E} onClick={()=>onKeyPress('E')} /></div>
              <div className="col-span-2"><Key labelArr={layout.R} onClick={()=>onKeyPress('R')} /></div>
              <div className="col-span-2"><Key labelArr={layout.T} onClick={()=>onKeyPress('T')} /></div>
              <div className="col-span-2"><Key labelArr={layout.Y} onClick={()=>onKeyPress('Y')} /></div>
              <div className="col-span-2"><Key labelArr={layout.U} onClick={()=>onKeyPress('U')} tone="vowel" hint="U" /></div>
              <div className="col-span-2"><Key labelArr={layout.I} onClick={()=>onKeyPress('I')} tone="vowel" hint="I" /></div>
              <div className="col-span-2"><Key labelArr={layout.O} onClick={()=>onKeyPress('O')} tone="vowel" hint="O" /></div>
              <div className="col-span-2"><Key labelArr={layout.P} onClick={()=>onKeyPress('P')} tone="vowel" hint="P" /></div>
              
            </Row21>

            {/* Row 2 */}
            <Row21>
              
              <div className="col-span-2"><Key labelArr={layout.A} onClick={()=>onKeyPress('A')} /></div>
              <div className="col-span-2"><Key labelArr={layout.S} onClick={()=>onKeyPress('S')} /></div>
              <div className="col-span-2"><Key labelArr={layout.D} onClick={()=>onKeyPress('D')} /></div>
              <div className="col-span-2"><Key labelArr={layout.F} onClick={()=>onKeyPress('F')} /></div>
              <div className="col-span-2"><Key labelArr={layout.G} onClick={()=>onKeyPress('G')} /></div>
              <div className="col-span-2"><Key labelArr={layout.H} onClick={()=>onKeyPress('H')} /></div>
              <div className="col-span-2"><Key labelArr={layout.J} onClick={()=>onKeyPress('J')} tone="vowel" hint="J" /></div>
              <div className="col-span-2"><Key labelArr={layout.K} onClick={()=>onKeyPress('K')} tone="vowel" hint="K" /></div>
              <div className="col-span-2"><Key labelArr={layout.L} onClick={()=>onKeyPress('L')} tone="convert" hint="L" /></div>
              <div className="col-span-2"></div>
            </Row21>

            {/* Row 3 */}
            <Row21>
              <div className="col-span-2"></div>
              <div className="col-span-2"><Key labelArr={layout.Z} onClick={()=>onKeyPress('Z')} /></div>
              <div className="col-span-2"><Key labelArr={layout.X} onClick={()=>onKeyPress('X')} /></div>
              <div className="col-span-2"><Key labelArr={layout.C} onClick={()=>onKeyPress('C')} /></div>
              <div className="col-span-2"><Key labelArr={layout.V} onClick={()=>onKeyPress('V')} /></div>
              <div className="col-span-2"><Key labelArr={layout.B} onClick={()=>onKeyPress('B')} /></div>
              <div className="col-span-2"><Key labelArr={layout.N} onClick={()=>onKeyPress('N')} /></div>
              <div className="col-span-3"><Key labelArr={layout.M} onClick={()=>onKeyPress('M')} tone="convert" /></div>
              <div className="col-span-3"><Key labelArr={["⌫"]} onClick={()=>backspace()} tone="dark" /></div>
              
            </Row21>

            {/* Row 4 aligned to 21-col (4|12|4|1) */}
            <Row21>
              <div className="col-span-4"><WideKey tone="dark" disabled>123</WideKey></div>
              <div className="col-span-12"><WideKey onClick={()=>space()}>Space</WideKey></div>
              <div className="col-span-4"><WideKey tone="dark" onClick={()=>enter()}>⏎</WideKey></div>
              
            </Row21>

            {/* bottom actions */}
            <div className="grid grid-cols-2 gap-3 px-4 py-3 bg-[#FAFAFA]">
              <button onClick={savePost} className="h-[48px] rounded-xl bg-amber-400 hover:bg-amber-300 border border-amber-300 text-neutral-900 text-[16px] font-semibold">ግልጽ</button>
              <button onClick={clearInput} className="h-[48px] rounded-xl bg-neutral-900 hover:bg-neutral-800 text-white text-[16px] font-medium">ንጽህና</button>
            </div>
          </div>

          {/* TUTORIAL MODAL */}
          {helpOpen && (
            <div className="fixed inset-0 z-50">
              <div className="absolute inset-0 bg-black/40" onClick={()=>setHelpOpen(false)}></div>
              <div className="absolute inset-0 flex items-center justify-center p-4">
                <div className="w-full max-w-[780px] max-h-[86vh] overflow-y-auto rounded-2xl bg-white border border-neutral-200 shadow-lg">
                  <div className="flex items-center justify-between px-5 py-4 border-b">
                    <div className="text-lg font-semibold">ረዳት</div>
                    <button onClick={()=>setHelpOpen(false)} className="h-9 px-3 rounded-lg bg-neutral-900 text-white text-sm hover:bg-neutral-800">ውጣ</button>
                  </div>
                  <div className="p-5">
  <section className="mb-6">
    <h3 className="text-lg font-semibold mb-2">አቀማመጥ</h3>
    <p className="mb-2">የድምፅ ቁልፎች፣ የቀጣይ ቁልፍ እና የወ ጥምረት ቁልፍ ቦታቸውን ያስታውሱ።</p>
    <img src="/help/keyboard.png" alt="Keyboard" className="border rounded" />
  </section>
  <section className="mb-6">
    <h3 className="text-lg font-semibold mb-2">የተከታታይ ፊደሎች መጻፍ</h3>
    <p className="mb-2">የፊደል ቡድን ቁልፍን ይጫኑ፣ ከዚያ ቀጣይ (≫) ሲጫኑ በዚያ ቁልፍ ያሉ ሌሎች ፊደሎች ይመራሉ።</p>
    <img src="/help/ex1.png" alt="Example 1" />
  </section>
  <section className="mb-6">
    <h3 className="text-lg font-semibold mb-2">ድምፅ መቀየር</h3>
    <p className="mb-2">ሥር ፊደልን ከጻፉ በኋላ የሚፈለገውን ድምፅ ቁልፍ ይጫኑ።</p>
    <img src="/help/ex2.png" alt="Example 2" />
  </section>
  <section>
    <h3 className="text-lg font-semibold mb-2">የወ ቤተሰብ ፊደሎች መጻፍ</h3>
    <p className="mb-2">ሥር ፊደልን ከጻፉ በኋላ የወ ቁልፍን እና ድምፅ ቁልፍን ተከታትለው ይጫኑ።</p>
    <img src="/help/ex3.png" alt="Example 3" />
  </section>
</div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('app'));
    root.render(<RatanamaPlayground />);
  </script>
</body>
</html>
