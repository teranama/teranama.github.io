<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ተራናማ ሙከራ</title>
  <script src="https://cdn.tailwindcss.com"></script>
<script>
const BASE_W = 1024, BASE_H = 606;
const stage = document.getElementById('stage');
function fit(){
  const sw = window.innerWidth, sh = window.innerHeight;
  const s = Math.min(sw/BASE_W, sh/BASE_H, 1);
  stage.style.transform = `scale(${s})`;
}
window.addEventListener('load', fit);
window.addEventListener('resize', fit);
</script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script>
const BASE_W = 1024, BASE_H = 606;
const stage = document.getElementById('stage');
function fit(){
  const sw = window.innerWidth, sh = window.innerHeight;
  const s = Math.min(sw/BASE_W, sh/BASE_H, 1);
  stage.style.transform = `scale(${s})`;
}
window.addEventListener('load', fit);
window.addEventListener('resize', fit);
</script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script>
const BASE_W = 1024, BASE_H = 606;
const stage = document.getElementById('stage');
function fit(){
  const sw = window.innerWidth, sh = window.innerHeight;
  const s = Math.min(sw/BASE_W, sh/BASE_H, 1);
  stage.style.transform = `scale(${s})`;
}
window.addEventListener('load', fit);
window.addEventListener('resize', fit);
</script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script>
const BASE_W = 1024, BASE_H = 606;
const stage = document.getElementById('stage');
function fit(){
  const sw = window.innerWidth, sh = window.innerHeight;
  const s = Math.min(sw/BASE_W, sh/BASE_H, 1);
  stage.style.transform = `scale(${s})`;
}
window.addEventListener('load', fit);
window.addEventListener('resize', fit);
</script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic&display=swap" rel="stylesheet">
  <style>
    body { margin:0; padding:0; font-family:'Noto Sans Ethiopic',sans-serif; }
    #fitwrap{
  height:100vh; display:flex; align-items:flex-start; justify-content:center;
  overflow:hidden;
}
#stage{
  position:relative;
  width:1024px; height:606px;   /* 기준 해상도 고정 */
  transform-origin: top left;
}
#bgwrap{
  position:relative;
  width:100%; height:100%;
  background:url('img/pcdemo.png') no-repeat center top / 100% 100%;
}
    .overlay { position:absolute; }
    #output {
      width:55%; left:15%;
      font-size: 18px;
      line-height: 1.6;
      padding: 12px 14px;
      border: 1px solid #bbb;
      border-radius: 10px;
      background: #fff;
      resize: none;
      ime-mode: disabled;
    }
    .btn {
      min-width:180px; height:44px;
      border-radius:22px; border:none;
      font-size:16px; font-weight:600;
      cursor:pointer; margin:0 8px;
    }
    .btn-yellow { background:#facc15; }
    .btn-dark { background:#333; color:#fff; }
    .btn-sky { background:#38bdf8; }
    #closebtn {
      top:48px; right:113px;
      width:28px; height:28px;
      background:#e11d48; color:#fff;
      border:none; border-radius:6px;
      font-weight:bold; cursor:pointer;
    }
  
    /* Placeholder in red inside the textarea */
    #output.placeholder { color: red; }
	
	    /* 눌림 효과 */
    .flash {
      position:absolute;
      width:44px; height:auto;         /* 키 크기 대략 */
      transform:translate(-50%,-50%);
      pointer-events:none;
    }
	#preview-NEXT.default::after {
  content: none !important;
  border: none !important;
  width: 0 !important;
  height: 0 !important;
}
#preview-NEXT {
  font-size: 22px;
  text-shadow: 0.5px 0 currentColor, -0.5px 0 currentColor,
               0 0.5px currentColor, 0 -0.5px currentColor;
}

  </style>
</head>
<body>
<button onclick="location.href='index.html'" 
        style="position: fixed; top: 20px; right: 78px; 
               padding: 10px 18px; font-size: 1.1em; 
               background-color: #3f6fb8; color: #fff; 
               border: none; border-radius: 8px; cursor: pointer; 
               box-shadow: 0 2px 6px rgba(0,0,0,0.15);
               z-index: 9999;">
  Home
</button>
<div id="fitwrap">
  <div id="stage">
<div id="bgwrap">
  <button id="closebtn" class="overlay">X</button>
<!-- 우상단 두더지 아이콘 밑에 링크 추가 -->
<a href="mole.html" target="_blank"
   class="overlay"
   style="top:70px; right:130px; display:flex; flex-direction:column; align-items:center;
          text-decoration:none; color:#000; font-weight:bold; font-size:16px;
          z-index:1000;">   <!-- 추가 -->
  <img src="img/icon_mole.png" alt="두더지 아이콘" style="width:60px; height:auto; margin-top:30px; margin-bottom:4px;">
  የቡችላ ጨዋታ
</a>



  <div class="overlay" style="top:110px; left:7%; width:70%; text-align:center; font-size:16px; font-weight:500;">
    የፒሲ ኪቦርድን ከመጠቀም በኩል ከታች ያለውን የኪቦርድ እርዳታ ብቻ ተመልከቱ እና ያስገቡ።
<br>የእጅ ጣቶችን ቁልፍ ማግኘት ከቸገራችሁ ከመጀመሪያ የቡችላ ጨዋታውን ይሞክሩ።
  </div>
<div class="overlay" 
     style="top:200px; left:41%; width:70%; text-align:center;
            font-size:18px; font-weight:bold; color:#000;">
  የግቤት መንገድ
</div>
  <div class="overlay" 
     style="bottom:30px; left:-20%; width:70%; text-align:center;
            font-size:16px; font-weight:500; color:#fff;">
  
</div>

  <!-- Preview labels overlay container (inside #stage to follow scaling) -->
  <div id="previewLabels" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;"></div>


  <textarea id="output" class="overlay" style="top:188px; left:14%; height:220px;"></textarea>
  <div class="overlay" style="bottom:160px; left:50%; transform:translateX(-50%); display:flex; gap:20px;">
    

</div>

<script>

/* ========================
   TERANAMA PC INPUT ENGINE — textarea only
   - next(≫) keeps vowel order, wa handled
   - IME hard-block (readOnly + inputmode=none + composition prevention)
   ======================== */
const out = document.getElementById('output');

// === Placeholder setup (Amharic notice in red) ===
const placeholderText = "እባኮትን በመጻፍዎ በፊት የእንግሊዝኛ የጽሑፍ ሁኔታን ይምረጡ።";

function setPlaceholder(){
  out.value = placeholderText;
  out.classList.add("placeholder");
}
function clearPlaceholder(){
  if(out.classList.contains("placeholder")){
    out.value = "";
    out.classList.remove("placeholder");
  }
}
// initialize placeholder on load
window.addEventListener('load', () => { setPlaceholder(); }, { once:true });
// clear placeholder on focus
out.addEventListener('focus', () => { clearPlaceholder(); });
// clear placeholder on first typing
document.addEventListener('keydown', () => { clearPlaceholder(); }, { once:true });

// Keep focus off the textarea to avoid OS IME
window.addEventListener('load', () => { document.body.focus(); });
out.addEventListener('focus', (e) => { e.preventDefault(); document.body.focus(); });

// Ethiopic helpers
const getSeriesBase = (cp) => cp - (cp % 8);
const isEthiopic = (cp) => (cp >= 0x1200 && cp <= 0x137F);

// Ge'ez order mapping 0..6 (ä,u,i,a,e,ə,o)
const VOWEL_INDEX = { U:1, I:2, J:3, L:4, O:6 }; // K 별도 처리

// w-series base map (대표 4계열). 미존재 시 +7 폴백.
const wSeriesBaseMap = new Map(Object.entries({
  "ገ":"ጐ",
  "ቀ":"ቈ",
  "ቐ":"ቘ",
  "ከ":"ኰ",
  "ኀ":"ኈ"
}));
const wBaseSet = new Set([...wSeriesBaseMap.values()]);

// Base groups for 'next' cycling
const layout = {
  Q: ["ገ", "ጘ"], W: ["ወ","ፀ"], E: ["የ","ጸ"], R: ["አ","ጰ"], T: ["ቀ","ቐ"], Y: ["ዘ","ዠ"],
  A: ["ተ","ፐ"], S: ["ረ","ፈ"], D: ["ነ","ኘ"], F: ["መ","ሐ"], G: ["ከ","ኸ"], H: ["ጠ","ጨ"],
  Z: ["ደ","ጀ"], X: ["ሰ","ሸ"], C: ["ለ","ኀ"], V: ["በ","ቨ"], B: ["ሀ","ሠ"], N: ["ቸ","ዐ"],
  M: ["next"]
};
const baseToGroup = new Map();
for (const arr of Object.values(layout)) {
  if (arr[0] === "next") continue;
  if (arr.length < 2) continue;
  for (const ch of arr) baseToGroup.set(ch, arr);
}

// text helpers
const getText = () => out.classList.contains('placeholder') ? '' : out.value;
const setText = (s) => { if(!s){ setPlaceholder(); } else { out.value = s; out.classList.remove('placeholder'); } };
const insert = (t) => setText(getText() + t);
const backspace = () => setText(getText().slice(0, -1));
const newline = () => insert("\n");
const space   = () => insert(" ");

// Base insert mapping
const keyToBaseInsert = {
  Q:"ገ", W:"ወ", E:"የ", R:"አ", T:"ቀ", Y:"ዘ",
  A:"ተ", S:"ረ", D:"ነ", F:"መ", G:"ከ", H:"ጠ",
  Z:"ደ", X:"ሰ", C:"ለ", V:"በ", B:"ሀ", N:"ቸ"
};

// Vowel apply
function applyVowelIndex(orderIndex) {
  const prev = getText(); if (!prev) return;
  const chars = Array.from(prev);
  const last = chars[chars.length - 1];
  const cp = last.codePointAt(0); if (!isEthiopic(cp)) return;
  const base = getSeriesBase(cp);
  const newCp = base + orderIndex;
  try { chars[chars.length - 1] = String.fromCodePoint(newCp); setText(chars.join("")); } catch {}
}

// K key: ə then w-series
function onKPress() {
  const prev = getText();
  if (!prev) { beep(); return; }
  const chars = Array.from(prev);
  const i = chars.length - 1;
  const cp = chars[i].codePointAt(0);
  if (!isEthiopic(cp)) { beep(); return; }

  let base = getSeriesBase(cp);
  let order = cp - base;
  let baseChar = String.fromCodePoint(base);

  // ★ 이미 w-시리즈면: K → 0형(베이스)
  if (wBaseSet.has(baseChar) || order === 7) {
    const wBaseChar = wBaseSet.has(baseChar) ? baseChar : wSeriesBaseMap.get(baseChar);
    if (wBaseChar) {
      chars[i] = wBaseChar;  // 0형으로 교체
      setText(chars.join(""));
      return;
    }
  }

  // 아직 w-시리즈 아님
  if (order !== 5) {
    // 첫 K → ə(5형)
    chars[i] = String.fromCodePoint(base + 5);
  } else {
    // 두 번째 K → w-시리즈 진입
    const wBaseChar = wSeriesBaseMap.get(baseChar);
    chars[i] = wBaseChar ? wBaseChar : String.fromCodePoint(base + 7);
  }
  setText(chars.join(""));
}


// Standalone vowels when no target
const standaloneByKey = { U:"ኡ", I:"ኢ", O:"ኦ", J:"ኣ", L:"ኤ" };
function onVowelKey(k) {
  let orderIndex = VOWEL_INDEX[k];
  const prev = getText();
  if (!prev) { beep(); return; }

  const chars = Array.from(prev);
  const last  = chars[chars.length - 1];
  const cp    = last.codePointAt(0);
  if (!isEthiopic(cp)) { beep(); return; }

  let base = getSeriesBase(cp);
  let baseChar = String.fromCodePoint(base);

  // (가짜) +7에서 들어온 경우엔 진짜 w-베이스로 전환
  const order = cp - base; // 0..7
  if (order === 7) {
    const wBaseChar = wSeriesBaseMap.get(baseChar);
    if (wBaseChar) { baseChar = wBaseChar; base = wBaseChar.codePointAt(0); }
  }

  // ★ w-시리즈에서는 'O'를 5로 보정 → …o가 base+5
  const inWSeries = (order === 7) || wBaseSet.has(baseChar);
  if (inWSeries && k === 'O') orderIndex = 5;

  const newCp = base + orderIndex;
  chars[chars.length - 1] = String.fromCodePoint(newCp);
  setText(chars.join(""));
}

function beep(){ try{ new AudioContext().close(); }catch(e){} }

// 페이지 전역(다른 함수들과 같은 레벨)에 추가
let __beep_ctx;
async function beep(freq=880, duration=0.08) {
  try {
    const AC = window.AudioContext || window.webkitAudioContext;
    __beep_ctx = __beep_ctx || new AC();
    if (__beep_ctx.state === 'suspended') await __beep_ctx.resume();

    const osc = __beep_ctx.createOscillator();
    const gain = __beep_ctx.createGain();
    osc.type = 'square'; osc.frequency.value = freq;

    const now = __beep_ctx.currentTime;
    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(0.2, now + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);

    osc.connect(gain).connect(__beep_ctx.destination);
    osc.start(now);
    osc.stop(now + duration + 0.02);
  } catch {}
}

// Next (≫): keep vowel order; wa stays wa
function nextTransform() {
  const prev = getText(); if (!prev) return;
  const chars = Array.from(prev);
  const last = chars[chars.length - 1];
  const cp = last.codePointAt(0); if (!isEthiopic(cp)) return;

  const base = getSeriesBase(cp);
  const order = cp - base; // 0..7

  const baseChar = String.fromCodePoint(base);
  const group = baseToGroup.get(baseChar);
  if (!group || group.length < 2) return;

  const idx = group.indexOf(baseChar);
  const nextBaseChar = group[(idx + 1) % group.length];
  const nextBase = nextBaseChar.codePointAt(0);

  let newChar;
  if (order === 7) {
    const wBase = wSeriesBaseMap.get(nextBaseChar);
    newChar = wBase ? wBase : String.fromCodePoint(nextBase + 7);
  } else {
    newChar = String.fromCodePoint(nextBase + order);
  }
  chars[chars.length - 1] = newChar;
  setText(chars.join(""));
}

// Hardware mapping
const codeToKey = {
  KeyQ:'Q', KeyW:'W', KeyE:'E', KeyR:'R', KeyT:'T', KeyY:'Y',
  KeyU:'U', KeyI:'I', KeyO:'O',
  KeyA:'A', KeyS:'S', KeyD:'D', KeyF:'F', KeyG:'G', KeyH:'H',
  KeyJ:'J', KeyK:'K', KeyL:'L',
  KeyZ:'Z', KeyX:'X', KeyC:'C', KeyV:'V', KeyB:'B', KeyN:'N', KeyM:'M'
};

function onKeyPressLetter(k) {
  if (k === 'M') { nextTransform(); return; }
  if (k === 'K') { onKPress(); return; }
  if (k === 'U' || k === 'I' || k === 'J' || k === 'L' || k === 'O') { onVowelKey(k); return; }
  const base = keyToBaseInsert[k];
  if (!base) return;
  insert(base);
}

// Global keydown interception
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey || e.metaKey || e.altKey) return;
  const code = e.code;
  if (codeToKey[code]) { e.preventDefault(); e.stopPropagation(); onKeyPressLetter(codeToKey[code]); return; }
  if (code === 'Space') { e.preventDefault(); e.stopPropagation(); space(); return; }
  if (code === 'Enter') { e.preventDefault(); e.stopPropagation(); newline(); return; }
  if (code === 'Backspace') { e.preventDefault(); e.stopPropagation(); backspace(); return; }
}, true);

// Block composition & input on textarea
['beforeinput','input','compositionstart','compositionupdate','compositionend'].forEach(type => {
  out.addEventListener(type, (e) => { e.preventDefault(); e.stopPropagation(); return false; }, true);
});

</script>
<script>
const BASE_W = 1024, BASE_H = 720;
const stage = document.getElementById('stage');
function fit(){
  const sw = window.innerWidth, sh = window.innerHeight;
  const s = Math.min(sw/BASE_W, sh/BASE_H, 1);
  stage.style.transform = `scale(${s})`;
}
window.addEventListener('load', fit);
window.addEventListener('resize', fit);
</script>
<script>
/* ======= 눌림 효과 구현 ======= */
const kb = document.getElementById('bgwrap');
const keyPos = {
  // 1행
  KeyQ:{x:309,y:474}, KeyW:{x:356,y:474}, KeyE:{x:402,y:474}, KeyR:{x:448,y:474},
  KeyT:{x:495,y:474}, KeyY:{x:562,y:474}, KeyU:{x:608,y:474}, KeyI:{x:654,y:474}, KeyO:{x:701,y:474},
  // 2행
  KeyA:{x:322,y:512}, KeyS:{x:368,y:512}, KeyD:{x:414,y:512}, KeyF:{x:461,y:512},
  KeyG:{x:507,y:512}, KeyH:{x:574,y:512}, KeyJ:{x:620,y:512}, KeyK:{x:666,y:512}, KeyL:{x:713,y:512},
  // 3행
  KeyZ:{x:345,y:549}, KeyX:{x:392,y:549}, KeyC:{x:438,y:549}, KeyV:{x:484,y:549},
  KeyB:{x:530,y:549}, KeyN:{x:597,y:549}, KeyM:{x:644,y:549},
};

function flashAt(x,y){
  const el = document.createElement('img');
  el.src = 'img/pressed.png';
  el.className = 'flash';
  el.style.left = x+'px';
  el.style.top  = y+'px';
  kb.appendChild(el);
  setTimeout(()=>el.remove(), 160);
}

window.addEventListener('keydown', e=>{
  const code = (e.code === 'Space') ? 'Space' : e.code;
  const pos = keyPos[code];
  if(!pos) return;
  flashAt(pos.x, pos.y);
}, true);

// ===== Preview labels with Abyssinica SIL font + NEXT adjusted =====
(function(){
  const style = document.createElement('style');
  style.textContent = `
    #previewLabels div{
      font-family:"Abyssinica SIL","Noto Sans Ethiopic",system-ui,-apple-system,Arial,sans-serif !important;
      font-weight:400 !important;
    }
    #preview-NEXT{ position:absolute; transform:translate(-40%,-45%) !important; font-size:22px !important; font-weight:400;}
    #preview-NEXT.default::after{
      content:''; position:absolute;
      width:12px; height:12px; border-radius:50%;
      border:2px dotted #999;
      top:0px; right:14px;
    }`;
  document.head.appendChild(style);

  const out=document.getElementById('output');
  function getText(){ return out.classList.contains('placeholder') ? '' : out.value; }

  const keyPos={
    KeyU:{x:607,y:474}, KeyI:{x:653,y:474}, KeyO:{x:700,y:474},
    KeyJ:{x:618,y:512}, KeyK:{x:665,y:512}, KeyL:{x:711,y:512},
    KeyM:{x:643,y:549}
  };
  const defaults={KeyU:'ኡ',KeyI:'ኢ',KeyO:'ኦ',KeyJ:'ኣ',KeyK:'እ',KeyL:'ኤ',KeyM:'⇆'};
  const idMap={KeyU:'preview-U',KeyI:'preview-I',KeyO:'preview-O',KeyJ:'preview-J',KeyK:'preview-K',KeyL:'preview-L',KeyM:'preview-NEXT'};
  const container=document.getElementById('previewLabels');
  for(const code in keyPos){
    const {x,y}=keyPos[code];
    const div=document.createElement('div');
    div.id=idMap[code];
    div.style.position='absolute';
    div.style.left=x+'px'; div.style.top=y+'px';
    div.style.transform='translate(-50%,-50%)';
    div.style.fontSize='22px'; div.style.color='#999';
    div.style.zIndex=9999;
    div.textContent=defaults[code];
    if(code==='KeyM') div.classList.add('default');
    container.appendChild(div);
  }

  const VOWEL_INDEX={U:1,I:2,J:3,L:4,O:6};
  const wSeriesBaseMap=new Map(Object.entries({"ገ":"ጐ","ቀ":"ቈ","ቐ":"ቘ","ከ":"ኰ","ኀ":"ኈ"}));
  const wBaseSet=new Set([...wSeriesBaseMap.values()]);
  const layoutGroups={Q:["ገ","ጘ"],W:["ወ","ፀ"],E:["የ","ጸ"],R:["አ","ጰ"],T:["ቀ","ቐ"],Y:["ዘ","ዠ"],
    A:["ተ","ፐ"],S:["ረ","ፈ"],D:["ነ","ኘ"],F:["መ","ሐ"],G:["ከ","ኸ"],H:["ጠ","ጨ"],Z:["ደ","ጀ"],X:["ሰ","ሸ"],C:["ለ","ኀ"],V:["በ","ቨ"],B:["ሀ","ሠ"],N:["ቸ","ዐ"]};
  const baseToGroup=new Map();for(const arr of Object.values(layoutGroups))for(const ch of arr)baseToGroup.set(ch,arr);
  const isEth=cp=>cp>=0x1200&&cp<=0x137F;const baseOf=cp=>cp-(cp%8);
  function lastEth(){const t=getText();const arr=Array.from(t);for(let i=arr.length-1;i>=0;i--){const cp=arr[i].codePointAt(0);if(isEth(cp))return arr[i];}return null;}
  function endsWS(){return /\s$/.test(getText());}
  function nextOf(ch){const cp=ch.codePointAt(0);const base=baseOf(cp);const order=cp-base;const baseChar=String.fromCodePoint(base);const group=baseToGroup.get(baseChar);if(!group)return null;const idx=group.indexOf(baseChar);const nextBaseChar=group[(idx+1)%group.length];const nextBase=nextBaseChar.codePointAt(0);if(order===7){const wBase=wSeriesBaseMap.get(nextBaseChar);return wBase?wBase:String.fromCodePoint(nextBase+7);}return String.fromCodePoint(nextBase+order);}
  function vowelPreview(ch,key){let ord=VOWEL_INDEX[key];const cp=ch.codePointAt(0);const base=baseOf(cp);const order=cp-base;const baseChar=String.fromCodePoint(base);const inW=(order===7)||wBaseSet.has(baseChar);if(inW&&key==='O')ord=5;return String.fromCodePoint(base+ord);}
  function kPreview(ch){const cp=ch.codePointAt(0);const base=baseOf(cp);const baseChar=String.fromCodePoint(base);const first=String.fromCodePoint(base+5);const wBase=wSeriesBaseMap.get(baseChar);const second=wBase?wBase:String.fromCodePoint(base+7);return first+second;}

  function setLabel(id,text,color,opts){
    const el=document.getElementById(id); if(!el) return;
    el.textContent=text; el.style.color=color;
    if(id==='preview-NEXT'){
      if(opts && opts.defaultState) el.classList.add('default');
      else el.classList.remove('default');
    }
  }

  function resetPrev(){
    setLabel('preview-U','ኡ','#999');
    setLabel('preview-I','ኢ','#999');
    setLabel('preview-O','ኦ','#999');
    setLabel('preview-J','ኣ','#999');
    setLabel('preview-K','እ','#999');
    setLabel('preview-L','ኤ','#999');
    setLabel('preview-NEXT','⇆','#999',{defaultState:true});
  }
  function updatePrev(){
    const last=lastEth();
    if(!last||endsWS()){ resetPrev(); return; }
    setLabel('preview-U',vowelPreview(last,'U'),'#1a73e8');
    setLabel('preview-I',vowelPreview(last,'I'),'#1a73e8');
    setLabel('preview-O',vowelPreview(last,'O'),'#1a73e8');
    setLabel('preview-J',vowelPreview(last,'J'),'#1a73e8');
    setLabel('preview-L',vowelPreview(last,'L'),'#1a73e8');
    setLabel('preview-K',kPreview(last),'#1a73e8');
    setLabel('preview-NEXT',nextOf(last)||'⇆','#1a73e8',{defaultState:false});
  }

  window.__updatePrev=updatePrev;
  window.addEventListener('load',resetPrev);
  function wrap(name){
    const orig=window[name]; if(typeof orig!=='function') return;
    window[name]=function(...args){const ret=orig.apply(this,args); try{window.__updatePrev();}catch(_){ } return ret;};
  }
  ['onKeyPressLetter','onVowelKey','onKPress','applyVowelIndex','nextTransform','insert','backspace','space','newline'].forEach(wrap);
  document.addEventListener('keydown',()=>setTimeout(()=>{try{window.__updatePrev();}catch(_){ }},0),true);
})();
</script>

<!-- === Override Patch (non-intrusive) === -->
<script>
(function(){
  try{
    // 1) K도 모음키로: VOWEL_INDEX에 5 추가
    if (typeof VOWEL_INDEX === 'object') {
      VOWEL_INDEX.K = 5;
    }

    // 2) onKeyPressLetter K 분기 override
    if (typeof onKeyPressLetter === 'function') {
      const _orig_onKeyPressLetter = onKeyPressLetter;
      window.onKeyPressLetter = function(k){
        if (k === 'K') { if (typeof onVowelKey==='function') onVowelKey('K'); return; }
        if (k === 'M') { if (typeof onExpandPress==='function') onExpandPress(); return; }
        return _orig_onKeyPressLetter(k);
      };
    }

    // 3) wSeriesRev 준비 (역매핑)
    if (typeof wSeriesRev === 'undefined' && typeof wSeriesBaseMap === 'object') {
      window.wSeriesRev = new Map(Array.from(wSeriesBaseMap.entries()).map(([k,v])=>[v,k]));
    }

    // 4) M키: 3-스테이지(서브 루트 → 기본 루트 와 → 서브 루트 와 → 서브 루트 …) 루트 직후만
    window.onExpandPress = function(){
      const prev = typeof getText==='function' ? getText() : document.getElementById('output').value;
      if (!prev) { if(typeof beep==='function')beep(); return; }
      const chars = Array.from(prev);
      const i = chars.length - 1;
      const cp = chars[i].codePointAt(0);
      if (typeof isEthiopic==='function' && !isEthiopic(cp)) { if(typeof beep==='function')beep(); return; }

      const base = (typeof getSeriesBase==='function') ? getSeriesBase(cp) : (cp - (cp%8));
      const baseChar = String.fromCodePoint(base);
      const baseCharRoot = (window.wSeriesRev && wSeriesRev.get(baseChar)) || baseChar;
      const group = (typeof baseToGroup!=='undefined') ? baseToGroup.get(baseCharRoot) : null;
      if (!group || group.length < 2) { if(typeof beep==='function')beep(); return; }

      const baseRoot = group[0], subRoot = group[1];
      const wBaseOf = (ch) => {
        const mapped = (typeof wSeriesBaseMap!=='undefined') ? wSeriesBaseMap.get(ch) : null;
        return mapped ? mapped.codePointAt(0) : ch.codePointAt(0) + 7;
      };

      const cpBase  = baseRoot.codePointAt(0);
      const cpSub   = subRoot.codePointAt(0);
      const cpBaseW = wBaseOf(baseRoot);
      const cpSubW  = wBaseOf(subRoot);

      // Only allow cycle when current cp is one of the 4 stage anchors.
      if (cp!==cpBase && cp!==cpSub && cp!==cpBaseW && cp!==cpSubW) { if(typeof beep==='function')beep(); return; }

      let next;
      if      (cp === cpBase)  next = cpSub;   // base -> sub
      else if (cp === cpSub)   next = cpBaseW; // sub  -> base w
      else if (cp === cpBaseW) next = cpSubW;  // base w -> sub w
      else if (cp === cpSubW)  next = cpSub;   // sub w -> sub

      chars[i] = String.fromCodePoint(next);
      if (typeof setText==='function') setText(chars.join(""));
      else document.getElementById('output').value = chars.join("");
    };

    // 5) Preview 덮어쓰기: K는 ə, NEXT는 expandPreview(동일 3-스테이지)
    if (typeof __updatePrev === 'function') {
      const _orig_updatePrev = __updatePrev;
      const baseOf=cp=>cp-(cp%8);
      const wOf=(c)=>{const m=wSeriesBaseMap.get(c); return m?m:String.fromCodePoint(c.codePointAt(0)+7);};
      function kPreview(ch){ const cp=ch.codePointAt(0); const base=baseOf(cp); return String.fromCodePoint(base+5); }
      function expandPreview(ch){
        const cp=ch.codePointAt(0), base=baseOf(cp), order=cp-base;
        if(order!==0) return '⇆';
        const baseChar=String.fromCodePoint(base);
        const baseCharRoot=(window.wSeriesRev&&wSeriesRev.get(baseChar))||baseChar;
        const group=baseToGroup.get(baseCharRoot); if(!group||group.length<2) return '⇆';
        const baseRoot=group[0], subRoot=group[1];
        const stages=[ subRoot.codePointAt(0), wOf(baseRoot).codePointAt(0), wOf(subRoot).codePointAt(0) ];
        const idx=stages.indexOf(cp);
        const nextCp = (idx===-1)?stages[0]:stages[(idx+1)%stages.length];
        return String.fromCodePoint(nextCp);
      }
      const setLabel = window.setLabel || function(id,text,color,opts){
        const el=document.getElementById(id); if(!el) return;
        el.textContent=text; el.style.color=color||'#1a73e8';
        if(id==='preview-NEXT'){
          if(opts && opts.defaultState) el.classList.add('default');
          else el.classList.remove('default');
        }
      };
      window.__updatePrev = function(){
        try{
          const lastEth = (function(){const t=(typeof getText==='function'?getText():document.getElementById('output').value);
              const arr=Array.from(t); for(let i=arr.length-1;i>=0;i--){const cp=arr[i].codePointAt(0);
                if(cp>=0x1200&&cp<=0x137F) return arr[i];} return null;})();
          const endsWS = (/\s$/.test(typeof getText==='function'?getText():document.getElementById('output').value));
          if(!lastEth||endsWS){
            setLabel('preview-U','ኡ','#999');
            setLabel('preview-I','ኢ','#999');
            setLabel('preview-O','ኦ','#999');
            setLabel('preview-J','ኣ','#999');
            setLabel('preview-L','ኤ','#999');
            setLabel('preview-K','እ','#999');
            setLabel('preview-NEXT','⇆','#999',{defaultState:true});
          }else{
            // reuse vowelPreview from original if present; else approximate via base+index
            const baseOf=cp=>cp-(cp%8);
            const vowel5 = (ch)=>{ const cp=ch.codePointAt(0); const base=baseOf(cp); return String.fromCodePoint(base+5); };
            const vowelIdx=(ch,idx)=>{ const cp=ch.codePointAt(0); const base=baseOf(cp); return String.fromCodePoint(base+idx); };
            setLabel('preview-U',vowelIdx(lastEth,1),'#1a73e8');
            setLabel('preview-I',vowelIdx(lastEth,2),'#1a73e8');
            setLabel('preview-O',vowelIdx(lastEth,6),'#1a73e8');
            setLabel('preview-J',vowelIdx(lastEth,3),'#1a73e8');
            setLabel('preview-L',vowelIdx(lastEth,4),'#1a73e8');
            setLabel('preview-K',vowel5(lastEth),'#1a73e8');
            setLabel('preview-NEXT',expandPreview(lastEth)||'⇆','#1a73e8',{defaultState:false});
          }
        }catch(e){
          _orig_updatePrev();
        }
      };
    }

  }catch(e){ console.warn('Override patch failed:', e); }
})();
</script>


<!-- === Minimal M-key override: 1230 cycle only === -->
<script>
(function(){
  try{
    // Ensure reverse map exists (for safety)
    if (typeof wSeriesRev === 'undefined' && typeof wSeriesBaseMap === 'object') {
      window.wSeriesRev = new Map(Array.from(wSeriesBaseMap.entries()).map(([k,v])=>[v,k]));
    }

    // M cycle: sub(1) -> baseW(2) -> subW(3) -> base(0) -> repeat
    window.onExpandPress = function(){
      const out = document.getElementById('output');
      const prev = (typeof getText==='function') ? getText() : (out?out.value:"");
      if (!prev) { if(typeof beep==='function')beep(); return; }
      const chars = Array.from(prev);
      const i = chars.length - 1;
      const cp = chars[i].codePointAt(0);
      if (typeof isEthiopic==='function' && !isEthiopic(cp)) { if(typeof beep==='function')beep(); return; }

      const base = (typeof getSeriesBase==='function') ? getSeriesBase(cp) : (cp - (cp%8));
      const baseChar = String.fromCodePoint(base);
      const baseCharRoot = (typeof wSeriesRev!=='undefined' && wSeriesRev.get(baseChar)) || baseChar;
      const group = (typeof baseToGroup!=='undefined') ? baseToGroup.get(baseCharRoot) : null;
      if (!group || group.length < 2) { if(typeof beep==='function')beep(); return; }

      const baseRoot = group[0], subRoot = group[1];
      const wBaseOf = (ch) => {
        const mapped = (typeof wSeriesBaseMap!=='undefined') ? wSeriesBaseMap.get(ch) : null;
        return mapped ? mapped.codePointAt(0) : ch.codePointAt(0) + 7;
      };

      const cpBase  = baseRoot.codePointAt(0);
      const cpSub   = subRoot.codePointAt(0);
      const cpBaseW = wBaseOf(baseRoot);
      const cpSubW  = wBaseOf(subRoot);

      const anchors = [cpBase, cpSub, cpBaseW, cpSubW];
      if (!anchors.includes(cp)) { if(typeof beep==='function')beep(); return; }

      const stages = [cpSub, cpBaseW, cpSubW, cpBase]; // 1,2,3,0
      let idx = stages.indexOf(cp);
      if (idx === -1) idx = stages.length - 1; // if at base, next is sub
      const next = stages[(idx+1)%stages.length];

      chars[i] = String.fromCodePoint(next);
      if (typeof setText==='function') setText(chars.join(""));
      else if(out) out.value = chars.join("");
    };

    // Route M to onExpandPress only (do not touch other keys)
    if (typeof onKeyPressLetter === 'function') {
      const __orig_onKeyPressLetter = onKeyPressLetter;
      window.onKeyPressLetter = function(k){
        if (k === 'M') { if (typeof onExpandPress==='function') onExpandPress(); return; }
        return __orig_onKeyPressLetter(k);
      };
    }
  }catch(e){ /* silent */ }
})();
</script>


<!-- === Minimal Preview Override: blank unsupported vowels in w-series === -->
<script>
(function(){
  try{
    // Helper to safely get last Ethiopic char
    function __lastEth(){
      const out = document.getElementById('output');
      const t = (typeof getText==='function') ? getText() : (out?out.value:"");
      const arr = Array.from(t);
      for (let i=arr.length-1;i>=0;i--){
        const cp = arr[i].codePointAt(0);
        if (cp>=0x1200 && cp<=0x137F) return arr[i];
      }
      return null;
    }
    // Wrapper around existing preview updater (if any)
    const setLabel = window.setLabel || function(id,text,color,opts){
      const el=document.getElementById(id); if(!el) return;
      el.textContent = text;
      if (color) el.style.color = color;
      if(id==='preview-NEXT'){
        if(opts && opts.defaultState) el.classList.add('default');
        else el.classList.remove('default');
      }
    };

    window.__updatePrev = (function(prev){
      return function(){
        // Run original first (if exists) to keep everything else identical
        if (typeof prev === 'function') { try{ prev(); }catch(e){} }
        try{
          const last = __lastEth();
          if (!last) return;
          const cp = last.codePointAt(0);
          const base = cp - (cp % 8);
          const order = cp - base;
          const baseChar = String.fromCodePoint(base);

          // inW if explicit w-base or synthetic +7
          const wSeriesBaseMap = new Map(Object.entries({"ገ":"ጐ","ቀ":"ቈ","ቐ":"ቘ","ከ":"ኰ","ኀ":"ኈ"}));
          const wBaseSet = new Set([...wSeriesBaseMap.values()]);
          const inW = (order === 7) || wBaseSet.has(baseChar);

          if (inW){
            // Blank out unsupported vowels (U, I, J, L) — KEEP K & O as-is
            setLabel('preview-U','', '#999');
            setLabel('preview-I','', '#999');
            setLabel('preview-J','', '#999');
            setLabel('preview-L','', '#999');
          }
        }catch(e){}
      };
    })(window.__updatePrev);
  }catch(e){}
})();
</script>


<!-- === Preview rule: single-wa-only series => show only J, others blank === -->
<script>
(function(){
  try{
    // canonical 5 w-series bases (already in the page earlier)
    const wSeriesBaseMap = new Map(Object.entries({"ገ":"ጐ","ቀ":"ቈ","ቐ":"ቘ","ከ":"ኰ","ኀ":"ኈ"}));
    const canonicalW = new Set([...wSeriesBaseMap.values()]); // {ጐ, ቈ, ቘ, ኰ, ኈ}

    function __lastEth(){
      const out = document.getElementById('output');
      const t = (typeof getText==='function') ? getText() : (out?out.value:"");
      const arr = Array.from(t);
      for (let i=arr.length-1;i>=0;i--){
        const cp = arr[i].codePointAt(0);
        if (cp>=0x1200 && cp<=0x137F) return arr[i];
      }
      return null;
    }
    function __baseOf(cp){ return cp - (cp % 8); }

    const __setLabel = window.setLabel || function(id,text,color,opts){
      const el=document.getElementById(id); if(!el) return;
      el.textContent = text;
      if (color) el.style.color = color;
      if(id==='preview-NEXT'){
        if(opts && opts.defaultState) el.classList.add('default');
        else el.classList.remove('default');
      }
    };

    // Wrap/override preview after existing one runs
    window.__updatePrev = (function(prev){
      return function(){
        if (typeof prev === 'function') { try{ prev(); }catch(e){} }
        try{
          const last = __lastEth(); if (!last) return;
          const cp = last.codePointAt(0);
          const base = __baseOf(cp);
          const order = cp - base; // 0..7
          const baseChar = String.fromCodePoint(base);

          // inW if explicit canonical base or synthetic +7
          const isCanonicalW = canonicalW.has(baseChar);
          const isSyntheticW = (order === 7) && !isCanonicalW;
          if (isSyntheticW){
            // single-wa-only: show only J; blank others (U/I/L/K/O)
            __setLabel('preview-U','', '#999');
            __setLabel('preview-I','', '#999');
            __setLabel('preview-L','', '#999');
            __setLabel('preview-K','', '#999');
            __setLabel('preview-O','', '#999');
            // keep J as whatever original preview set (do not touch)
          }
        }catch(e){}
      };
    })(window.__updatePrev);
  }catch(e){}
})();
</script>


<!-- === FINAL preview override (canonical W shows full set; synthetic W shows only J) === -->
<script>
(function(){
  try{
    const canonicalW = new Set(["ጐ","ቈ","ቘ","ኰ","ኈ"]);
    function __lastEth(){
      const out = document.getElementById('output');
      const t = (typeof getText==='function') ? getText() : (out?out.value:"");
      const arr = Array.from(t);
      for (let i=arr.length-1;i>=0;i--){
        const cp = arr[i].codePointAt(0);
        if (cp>=0x1200 && cp<=0x137F) return arr[i];
      }
      return null;
    }
    function __baseOf(cp){ return cp - (cp % 8); }
    function __setLabel(id,text,color){
      const el=document.getElementById(id); if(!el) return;
      el.textContent = text;
      if (color) el.style.color = color;
    }

    // wrap to run *after* any previous preview updates
    const __prev = window.__updatePrev;
    window.__updatePrev = function(){
      if (typeof __prev === 'function') { try{ __prev(); }catch(e){} }
      try{
        const last = __lastEth(); if (!last) return;
        const cp = last.codePointAt(0);
        const base = __baseOf(cp);
        const order = cp - base; // 0..7
        const baseChar = String.fromCodePoint(base);

        const inCanonical = canonicalW.has(baseChar);
        const inSynthetic = (order === 7) && !inCanonical;

        if (inCanonical){
          // full W base: U/I/J/L/O active (O=>5)
          __setLabel('preview-U', String.fromCodePoint(base + 1), '#1a73e8');
          __setLabel('preview-I', String.fromCodePoint(base + 2), '#1a73e8');
          __setLabel('preview-J', String.fromCodePoint(base + 3), '#1a73e8');
          __setLabel('preview-L', String.fromCodePoint(base + 4), '#1a73e8');
          __setLabel('preview-O', String.fromCodePoint(base + 5), '#1a73e8');
          // K 라벨은 기존 로직 유지
          return;
        }
        if (inSynthetic){
          // single-wa-only: show only J
          __setLabel('preview-U','', '#999');
          __setLabel('preview-I','', '#999');
          __setLabel('preview-L','', '#999');
          __setLabel('preview-K','', '#999');
          __setLabel('preview-O','', '#999');
          // J는 그대로 (이미 찍혀 있음)
          return;
        }
      }catch(e){}
    };
  }catch(e){}
})();
</script>


<!-- === NEXT preview final rule: default '⇆' gray; active shows next cycle; vowels -> inactive === -->
<script>
(function(){
  try{
    function __lastEth(){
      const out = document.getElementById('output');
      const t = (typeof getText==='function') ? getText() : (out?out.value:"");
      const arr = Array.from(t);
      for (let i=arr.length-1;i>=0;i--){
        const cp = arr[i].codePointAt(0);
        if (cp>=0x1200 && cp<=0x137F) return arr[i];
      }
      return null;
    }
    const baseOf = (cp)=>cp-(cp%8);
    const isEth = (cp)=>cp>=0x1200&&cp<=0x137F;

    // Helpers shared with the page
    const wSeriesBaseMap = new Map(Object.entries({"ገ":"ጐ","ቀ":"ቈ","ቐ":"ቘ","ከ":"ኰ","ኀ":"ኈ"}));
    const baseToGroup = (function(){
      // reconstruct from layout already on page if needed
      const layoutGroups={Q:["ገ","ጘ"],W:["ወ","ፀ"],E:["የ","ጸ"],R:["አ","ጰ"],T:["ቀ","ቐ"],Y:["ዘ","ዠ"],
        A:["ተ","ፐ"],S:["ረ","ፈ"],D:["ነ","ኘ"],F:["መ","ሐ"],G:["ከ","ኸ"],H:["ጠ","ጨ"],
        Z:["ደ","ጀ"],X:["ሰ","ሸ"],C:["ለ","ኀ"],V:["በ","ቨ"],B:["ሀ","ሠ"],N:["ቸ","ዐ"]};
      const m=new Map(); for(const arr of Object.values(layoutGroups)) for(const ch of arr) m.set(ch,arr); return m;
    })();

    function nextCycleChar(ch){
      const cp = ch.codePointAt(0); if(!isEth(cp)) return null;
      const base = baseOf(cp);
      const baseChar = String.fromCodePoint(base);
      // get roots for the group of the *root* (strip w-base if needed)
      const rootChar = (function(){
        // if current is a w-base (canonical), find its root via reverse of map
        for (const [root,w] of wSeriesBaseMap.entries()){
          if (w === baseChar) return root;
        }
        // otherwise use baseChar as-is
        return baseChar;
      })();
      const group = baseToGroup.get(rootChar); if(!group||group.length<2) return null;
      const baseRoot = group[0], subRoot = group[1];

      const cpBase  = baseRoot.codePointAt(0);
      const cpSub   = subRoot.codePointAt(0);
      const cpBaseW = (wSeriesBaseMap.get(baseRoot)||String.fromCodePoint(cpBase+7)).codePointAt(0);
      const cpSubW  = (wSeriesBaseMap.get(subRoot )||String.fromCodePoint(cpSub +7)).codePointAt(0);

      const anchors = [cpSub, cpBaseW, cpSubW, cpBase]; // 1230 cycle
      if (!anchors.includes(cp)) return null;
      const idx = anchors.indexOf(cp);
      const next = anchors[(idx+1)%anchors.length];
      return String.fromCodePoint(next);
    }

    function setNextInactive(){
      const el = document.getElementById('preview-NEXT'); if(!el) return;
      el.textContent = '⇆';
      el.style.color = '#999';
      el.classList.add('default');
    }
    function setNextActive(char){
      const el = document.getElementById('preview-NEXT'); if(!el) return;
      el.textContent = char || '⇆';
      el.style.color = '#1a73e8';
      el.classList.remove('default');
    }

    const __prev = window.__updatePrev;
    window.__updatePrev = function(){
      if (typeof __prev === 'function') { try{ __prev(); }catch(e){} }
      try{
        const last = __lastEth();
        const out = document.getElementById('output');
const t = (typeof getText==='function') ? getText() : (out ? out.value : "");
const endsWS = /\s$/.test(t);

if (!last || !t || endsWS){ 
  setNextInactive(); 
  return; 
}

        const next = nextCycleChar(last);
        if (next){ setNextActive(next); } else { setNextInactive(); }
      }catch(e){ /* ignore */ }
    };

    // initialize default
    window.addEventListener('load', function(){
      try{ setNextInactive(); }catch(e){}
    });
  }catch(e){}
})();
</script>

</body>
</html>